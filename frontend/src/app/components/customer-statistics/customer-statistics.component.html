<div class="statistics-dashboard">
  <div class="dashboard-header">
    <h1><i class="fas fa-chart-bar"></i> Bảng Điều Khiển Thống Kê</h1>
    <div class="header-actions">
      <button class="btn btn-refresh" (click)="loadStatistics()" [disabled]="loading">
        <i class="fas fa-sync"></i>
      </button>
      <button class="btn btn-export" (click)="exportData()">
        <i class="fas fa-download"></i> Xuất CSV
      </button>
    </div>
  </div>

  <div class="loading-spinner" *ngIf="loading">
    <div class="spinner"></div>
    <p>Đang tải dữ liệu...</p>
  </div>

  <div class="error-message" *ngIf="error">
    <i class="fas fa-exclamation-circle"></i> {{ error }}
    <button class="close-btn" (click)="error = ''">×</button>
  </div>

  <div class="stats-grid" *ngIf="!loading && statistics">
    <!-- Total Customers -->
    <div class="stat-card">
      <div class="stat-icon customers">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Tổng Khách Hàng</p>
        <h3 class="stat-value">{{ statistics.totalCustomers | number }}</h3>
      </div>
    </div>

    <!-- Total Spending -->
    <div class="stat-card">
      <div class="stat-icon spending">
        <i class="fas fa-money-bill-wave"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Tổng Chi Tiêu</p>
        <h3 class="stat-value">{{ statistics.totalSpending | number:'0.0-0' }} đ</h3>
      </div>
    </div>

    <!-- Top Spenders -->
    <div class="stat-card">
      <div class="stat-icon tiers">
        <i class="fas fa-crown"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Top 10 Chi Tiêu Nhất</p>
        <p class="stat-subtext">{{ statistics.topSpenders ? statistics.topSpenders.length : 0 }} khách hàng</p>
      </div>
    </div>

    <!-- Tier Distribution -->
    <div class="stat-card">
      <div class="stat-icon tiers">
        <i class="fas fa-layer-group"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Phân Bố Hạng Thành Viên</p>
        <div class="tier-mini" *ngIf="statistics.tierDistribution">
          <span class="tier-item" *ngFor="let tier of getTierItems()">
            <span class="tier-name">{{ tier.tier }}</span>
            <span class="tier-count">{{ tier.count }}</span>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="charts-section" *ngIf="!loading && statistics">
    <!-- Tier Distribution Pie Chart -->
    <div class="chart-card">
      <h3><i class="fas fa-pie-chart"></i> Phân Bố Hạng Thành Viên</h3>
      <div class="chart-placeholder">
        <canvas id="tierChart" #tierChart></canvas>
        <div class="chart-legend">
          <div class="legend-item" *ngFor="let tier of getTierItems()">
            <span class="legend-color" [style.backgroundColor]="getTierColor(tier.tier)"></span>
            <span>{{ tier.tier }}: {{ tier.count }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Spending Trends -->
    <div class="chart-card">
      <h3><i class="fas fa-line-chart"></i> Xu Hướng Chi Tiêu</h3>
      <div class="chart-placeholder">
        <canvas id="spendingChart" #spendingChart></canvas>
      </div>
    </div>
  </div>

  <!-- Inactive Customers -->
  <div class="inactive-section" *ngIf="!loading && inactiveCustomers.length > 0">
    <h2><i class="fas fa-clock"></i> Khách Hàng Không Hoạt Động</h2>
    <div class="inactive-list">
      <div class="inactive-item" *ngFor="let customer of inactiveCustomers">
        <div class="customer-info">
          <h4>{{ customer.HoTen }}</h4>
          <p>{{ customer.SoDienThoai }} | {{ customer.LastPurchaseDate | date:'dd/MM/yyyy' }}</p>
        </div>
        <div class="days-inactive">
          <span class="badge">{{ customer.DaysSinceLastPurchase }} ngày</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Spenders -->
  <div class="top-spenders-section" *ngIf="!loading && statistics?.topSpenders && (statistics?.topSpenders?.length ?? 0) > 0">
    <h2><i class="fas fa-trophy"></i> Top 10 Khách Hàng Chi Tiêu Nhiều Nhất</h2>
    <table class="spenders-table">
      <thead>
        <tr>
          <th>Họ Tên</th>
          <th>Số Điện Thoại</th>
          <th>Hạng</th>
          <th>Tổng Chi Tiêu</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let spender of statistics?.topSpenders; let i = index">
          <td>
            <span class="rank">{{ i + 1 }}</span>
            {{ spender.HoTen }}
          </td>
          <td>{{ spender.SoDienThoai }}</td>
          <td>
            <span class="tier-badge" [ngClass]="'tier-' + (spender.TenHang || 'bronze')">
              {{ spender.TenHang || 'Bronze' }}
            </span>
          </td>
          <td class="amount">{{ spender.TongChiTieu | number:'0.0-0' }} đ</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
