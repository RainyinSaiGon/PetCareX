<div class="container">
  <div class="header-section">
    <div class="header-title">
      <i class="fa-solid fa-prescription-bottle"></i>
      <h1>Kê Toa Thuốc</h1>
    </div>
  </div>

  <!-- Medical Record Selection Section -->
  <div class="record-selection-section">
    <h3><i class="fa-solid fa-file-medical"></i> Chọn Hồ Sơ Bệnh Án</h3>
    <div class="record-search-container">
      <div class="search-input-group">
        <input type="text" [(ngModel)]="searchExaminationQuery"
          placeholder="Tìm kiếm theo tên thú cưng, mã hồ sơ hoặc khách hàng..." class="search-input" />
        <button (click)="searchExaminations()" class="btn btn-search">
          <i class="fa-solid fa-search"></i> Tìm Kiếm
        </button>
      </div>
      <div class="search-results" *ngIf="filteredExaminations.length > 0">
        <div *ngFor="let exam of filteredExaminations" (click)="selectExamination(exam)" class="search-result-item">
          <div class="result-header">
            <strong><i class="fa-solid fa-paw"></i> {{ exam.ThuCung?.TenThuCung }}</strong>
            <span class="result-code">#{{ exam.MaGiayKhamTongQuat }}</span>
          </div>
          <div class="result-details">
            <span class="detail">{{ exam.ThuCung?.ChungLoai?.TenChungLoaiThuCung || 'N/A' }}</span>
            <span class="detail">{{ exam.ThuCung?.KhachHang?.HoTen || 'N/A' }}</span>
            <span class="detail">{{ exam.NgayKham | date : 'dd/MM/yyyy HH:mm' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="selected-record" *ngIf="selectedExamination">
      <div class="selected-item">
        <i class="fa-solid fa-check-circle"></i>
        <div>
          <span class="label">Hồ sơ đã chọn:</span>
          <span class="value">{{ selectedExamination.ThuCung?.TenThuCung }} - #{{ selectedExamination.MaGiayKhamTongQuat
            }}</span>
          <span class="pet-info">
            <i class="fa-solid fa-user"></i> {{ selectedExamination.ThuCung?.KhachHang?.HoTen || 'Chưa có' }}
            <span class="separator">|</span>
            <i class="fa-solid fa-calendar"></i> {{ selectedExamination.NgayKham | date : 'dd/MM/yyyy HH:mm' }}
          </span>
        </div>
        <button (click)="clearExaminationSelection()" class="btn-clear" title="Chọn lại hồ sơ">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Medicine Search Section -->
  <div class="search-section">
    <h3><i class="fa-solid fa-capsules"></i> Thêm Thuốc Vào Toa</h3>
    <div class="medicine-search">
      <input type="text" [(ngModel)]="searchMedicineQuery" (ngModelChange)="searchMedicines()"
        placeholder="Tìm kiếm tên thuốc..." class="search-input" />
      <div class="search-results" *ngIf="filteredMedicines.length > 0">
        <div *ngFor="let medicine of filteredMedicines" (click)="selectMedicine(medicine)" class="search-result-item">
          <div class="result-header">
            <strong>{{ medicine.TenSanPham }}</strong>
            <span class="result-code">({{ medicine.MaSanPham }})</span>
          </div>
          <div class="result-price">{{ medicine.GiaSanPham | currency : 'VND' : 'symbol' : '0.0' }}</div>
        </div>
      </div>
    </div>

    <div class="medicine-form">
      <div class="form-row">
        <div class="form-group">
          <label>Thuốc</label>
          <input type="text" [(ngModel)]="newPrescriptionItem.maThuoc" disabled class="form-control"
            placeholder="Chọn thuốc từ danh sách" />
        </div>

        <div class="form-group">
          <label>Số Lượng</label>
          <input type="number" [(ngModel)]="newPrescriptionItem.soLuong" placeholder="1" class="form-control" min="1" />
        </div>

        <div class="form-group">
          <label>Ghi Chú</label>
          <input type="text" [(ngModel)]="newPrescriptionItem.ghiChu" placeholder="Cách dùng, liều lượng..."
            class="form-control" />
        </div>

        <button (click)="addPrescriptionItem()" class="btn btn-add">
          <i class="fa-solid fa-plus"></i> Thêm
        </button>
      </div>
    </div>
  </div>

  <!-- Prescription Details Section -->
  <div class="details-section" *ngIf="prescriptionForm.chiTiets.length > 0">
    <h3><i class="fa-solid fa-list"></i> Chi Tiết Toa Thuốc</h3>

    <div class="table-responsive">
      <table class="prescription-table">
        <thead>
          <tr>
            <th>MÃ THUỐC</th>
            <th>TÊN THUỐC</th>
            <th>GIÁ</th>
            <th>SỐ LƯỢNG</th>
            <th>THÀNH TIỀN</th>
            <th>GHI CHÚ</th>
            <th>HÀNH ĐỘNG</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of prescriptionForm.chiTiets; let i = index">
            <td class="code-cell">{{ item.maThuoc }}</td>
            <td class="name-cell">{{ item.tenSanPham }}</td>
            <td class="price-cell">{{ item.giaSanPham | currency : 'VND' : 'symbol' : '0.0' }}</td>
            <td class="qty-cell">{{ item.soLuong }}</td>
            <td class="total-cell">{{ (item.giaSanPham * item.soLuong) | currency : 'VND' : 'symbol' : '0.0' }}</td>
            <td class="note-cell">{{ item.ghiChu }}</td>
            <td class="action-cell">
              <button (click)="removePrescriptionItem(i)" class="btn-icon btn-danger" title="Xóa">
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="total-section">
      <div class="total-amount">
        <span>Tổng Tiền:</span>
        <span class="amount">{{ totalAmount | currency : 'VND' : 'symbol' : '0.0' }}</span>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="form-actions">
    <button (click)="submitForm()" class="btn btn-submit" [disabled]="isSubmitting">
      <i class="fa-solid fa-save"></i> {{ isSubmitting ? 'Đang lưu...' : 'Lưu Toa Thuốc' }}
    </button>
    <button (click)="resetForm()" class="btn btn-reset">
      <i class="fa-solid fa-redo"></i> Đặt lại
    </button>
  </div>
</div>