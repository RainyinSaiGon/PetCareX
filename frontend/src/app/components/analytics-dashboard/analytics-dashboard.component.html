<div class="analytics-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>B√°o C√°o & Ph√¢n T√≠ch</h1>
      <p class="subtitle">T·ªïng quan h·ªá th·ªëng v√† ph√¢n t√≠ch chi ti·∫øt</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline" (click)="loadAllData()">
        L√†m m·ªõi
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <div class="spinner"></div>
    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>

  <!-- Error -->
  <div class="alert alert-error" *ngIf="error">
    {{error}}
  </div>

  <!-- Dashboard Content -->
  <div class="dashboard-content" *ngIf="!loading && dashboard">
    
    <!-- KPI Cards -->
    <div class="kpi-section">
      <h2>Ch·ªâ S·ªë Ch√≠nh</h2>
      <div class="kpi-grid">
        <!-- Revenue Card -->
        <div class="kpi-card revenue-card">
          <div class="kpi-details">
            <h3>Doanh Thu</h3>
            <div class="kpi-values">
              <div class="kpi-value-item">
                <span class="label">H√¥m nay:</span>
                <span class="value">{{formatCurrency(dashboard.revenue.today)}}</span>
              </div>
              <div class="kpi-value-item">
                <span class="label">Tu·∫ßn n√†y:</span>
                <span class="value">{{formatCurrency(dashboard.revenue.thisWeek)}}</span>
              </div>
              <div class="kpi-value-item highlight">
                <span class="label">Th√°ng n√†y:</span>
                <span class="value">{{formatCurrency(dashboard.revenue.thisMonth)}}</span>
              </div>
              <div class="kpi-value-item">
                <span class="label">NƒÉm nay:</span>
                <span class="value">{{formatCurrency(dashboard.revenue.thisYear)}}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Customers Card -->
        <div class="kpi-card customers-card">
          <div class="kpi-details">
            <h3>Kh√°ch H√†ng</h3>
            <div class="kpi-values">
              <div class="kpi-value-item highlight">
                <span class="label">T·ªïng s·ªë:</span>
                <span class="value">{{formatNumber(dashboard.customers.total)}}</span>
              </div>
              <div class="kpi-value-item">
                <span class="label">Kh√°ch m·ªõi:</span>
                <span class="value">{{formatNumber(dashboard.customers.new)}}</span>
              </div>
              <div class="kpi-value-item">
                <span class="label">Th√†nh vi√™n:</span>
                <span class="value">{{formatNumber(dashboard.customers.members)}}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Appointments Card -->
        <div class="kpi-card appointments-card">
          <div class="kpi-details">
            <h3>L·ªãch H·∫πn</h3>
            <div class="kpi-values">
              <div class="kpi-value-item">
                <span class="label">H√¥m nay:</span>
                <span class="value">{{formatNumber(dashboard.appointments.today)}}</span>
              </div>
              <div class="kpi-value-item">
                <span class="label">Tu·∫ßn n√†y:</span>
                <span class="value">{{formatNumber(dashboard.appointments.thisWeek)}}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Employees Card -->
        <div class="kpi-card employees-card">
          <div class="kpi-details">
            <h3>Nh√¢n Vi√™n</h3>
            <div class="kpi-values">
              <div class="kpi-value-item highlight">
                <span class="label">T·ªïng s·ªë:</span>
                <span class="value">{{formatNumber(dashboard.employees.total)}}</span>
              </div>
              <div class="kpi-value-item">
                <span class="label">ƒêang l√†m:</span>
                <span class="value">{{formatNumber(dashboard.employees.active)}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Revenue Report Section -->
    <div class="report-section" *ngIf="revenueReport">
      <div class="section-header">
        <h2>B√°o C√°o Doanh Thu</h2>
        <div class="section-controls">
          <select [(ngModel)]="selectedPeriod" (change)="onPeriodChange()" class="form-control">
            <option value="week">7 ng√†y qua</option>
            <option value="month">Th√°ng n√†y</option>
            <option value="year">NƒÉm nay</option>
          </select>
          <select [(ngModel)]="selectedTimeFrame" (change)="onTimeFrameChange()" class="form-control">
            <option [value]="RevenueTimeFrame.DAILY">Theo ng√†y</option>
            <option [value]="RevenueTimeFrame.WEEKLY">Theo tu·∫ßn</option>
            <option [value]="RevenueTimeFrame.MONTHLY">Theo th√°ng</option>
            <option [value]="RevenueTimeFrame.YEARLY">Theo nƒÉm</option>
          </select>
        </div>
      </div>

      <div class="revenue-summary">
        <div class="summary-card">
          <h4>T·ªïng Doanh Thu</h4>
          <div class="summary-value">{{formatCurrency(revenueReport.totalRevenue)}}</div>
          <div class="comparison" *ngIf="revenueReport.comparison">
            <span [class]="getChangeClass(revenueReport.comparison.changePercentage)">
              {{formatPercentage(revenueReport.comparison.changePercentage)}}
            </span>
            <span class="comparison-label">so v·ªõi k·ª≥ tr∆∞·ªõc</span>
          </div>
        </div>

        <div class="summary-card">
          <h4>Doanh Thu S·∫£n Ph·∫©m</h4>
          <div class="summary-value">{{formatCurrency(revenueReport.productRevenue)}}</div>
        </div>
        <div class="summary-card">
          <h4>Doanh Thu D·ªãch V·ª•</h4>
          <div class="summary-value">{{formatCurrency(revenueReport.serviceRevenue)}}</div>
        </div>
      </div>

      <!-- Revenue Chart -->
      <div class="chart-container">
        <h4>Bi·ªÉu ƒê·ªì Doanh Thu</h4>
        <div class="bar-chart">
          <div class="chart-bars">
            <div 
              *ngFor="let value of revenueChartData; let i = index" 
              class="bar-wrapper">
              <div 
                class="bar" 
                [style.height.%]="getChartHeight(value, getMaxRevenue())"
                [title]="formatCurrency(value)">
                <span class="bar-value">{{formatCurrency(value)}}</span>
              </div>
              <span class="bar-label">{{revenueChartLabels[i]}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Revenue by Branch -->
      <div class="branch-revenue" *ngIf="revenueReport.revenueByBranch && revenueReport.revenueByBranch.length > 0">
        <h4>Doanh Thu Theo Chi Nh√°nh</h4>
        <div class="branch-list">
          <div *ngFor="let branch of revenueReport.revenueByBranch" class="branch-item">
            <span class="branch-name">{{branch.tenChiNhanh}}</span>
            <span class="branch-revenue">{{formatCurrency(branch.revenue)}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Services Section -->
    <div class="report-section" *ngIf="topServices.length > 0">
      <h2>üèÜ Top D·ªãch V·ª• (3 th√°ng qua)</h2>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>STT</th>
              <th>T√™n D·ªãch V·ª•</th>
              <th>S·ªë L·∫ßn S·ª≠ D·ª•ng</th>
              <th>T·ªïng Doanh Thu</th>
              <th>Gi√° Trung B√¨nh</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let service of topServices; let i = index">
              <td>{{i + 1}}</td>
              <td><strong>{{service.tenDichVu}}</strong></td>
              <td>{{formatNumber(service.soLanSuDung)}}</td>
              <td>{{formatCurrency(service.tongDoanhThu)}}</td>
              <td>{{formatCurrency(service.trungBinhGia)}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top Products Section -->
    <div class="report-section" *ngIf="dashboard.topProducts.length > 0">
      <h2>üõçÔ∏è Top S·∫£n Ph·∫©m (30 ng√†y qua)</h2>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>STT</th>
              <th>T√™n S·∫£n Ph·∫©m</th>
              <th>S·ªë L∆∞·ª£ng B√°n</th>
              <th>Doanh Thu</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let product of dashboard.topProducts; let i = index">
              <td>{{i + 1}}</td>
              <td><strong>{{product.tenSanPham}}</strong></td>
              <td>{{formatNumber(product.soLuongBan)}}</td>
              <td>{{formatCurrency(product.doanhThu)}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Member Tier Statistics -->
    <div class="report-section" *ngIf="memberTiers">
      <h2>Th·ªëng K√™ H·∫°ng Th√†nh Vi√™n</h2>
      
      <div class="tier-summary">
        <div class="tier-total">
          <h4>T·ªïng Th√†nh Vi√™n</h4>
          <div class="tier-total-value">{{formatNumber(memberTiers.totalMembers)}}</div>
        </div>
      </div>

      <!-- Tier Distribution -->
      <div class="tier-distribution">
        <h4>Ph√¢n B·ªë Theo H·∫°ng</h4>
        <div class="tier-grid">
          <div 
            *ngFor="let tier of memberTiers.tierDistribution; let i = index" 
            class="tier-card"
            [style.border-left-color]="getTierColor(i)">
            <h5>{{tier.tenHang}}</h5>
            <div class="tier-stats">
              <div class="tier-stat">
                <span class="tier-label">S·ªë l∆∞·ª£ng:</span>
                <span class="tier-value">{{formatNumber(tier.soLuongThanhVien)}}</span>
              </div>
              <div class="tier-stat">
                <span class="tier-label">T·ª∑ l·ªá:</span>
                <span class="tier-value">{{tier.tyLe.toFixed(1)}}%</span>
              </div>
              <div class="tier-stat">
                <span class="tier-label">Chi ti√™u TB:</span>
                <span class="tier-value">{{formatCurrency(tier.trungBinhChiTieu)}}</span>
              </div>
              <div class="tier-stat">
                <span class="tier-label">T·ªïng doanh thu:</span>
                <span class="tier-value">{{formatCurrency(tier.tongChiTieu)}}</span>
              </div>
            </div>
            <div class="tier-progress">
              <div 
                class="tier-progress-bar" 
                [style.width.%]="tier.tyLe"
                [style.background-color]="getTierColor(i)">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Upgrades -->
      <div class="recent-upgrades" *ngIf="memberTiers.recentUpgrades.length > 0">
        <h4>N√¢ng H·∫°ng G·∫ßn ƒê√¢y (30 ng√†y)</h4>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Kh√°ch H√†ng</th>
                <th>H·∫°ng C≈©</th>
                <th>H·∫°ng M·ªõi</th>
                <th>Ng√†y N√¢ng H·∫°ng</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let upgrade of memberTiers.recentUpgrades">
                <td><strong>{{upgrade.tenKhachHang}}</strong></td>
                <td>{{upgrade.hangCu}}</td>
                <td class="tier-upgrade">{{upgrade.hangMoi}} ‚¨ÜÔ∏è</td>
                <td>{{upgrade.ngayNangHang | date: 'dd/MM/yyyy'}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Employee Distribution -->
    <div class="report-section" *ngIf="dashboard.employees.byType.length > 0">
      <h2>üë®‚Äçüíº Ph√¢n B·ªë Nh√¢n Vi√™n Theo Lo·∫°i</h2>
      <div class="employee-distribution">
        <div *ngFor="let type of dashboard.employees.byType; let i = index" class="employee-type-card">
          <div class="type-icon">{{i + 1}}</div>
          <div class="type-info">
            <h4>{{type.loaiNhanVien}}</h4>
            <div class="type-count">{{formatNumber(type.soLuong)}} nh√¢n vi√™n</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
